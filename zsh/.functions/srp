#!/bin/zsh

local _srp_default_file="${XDG_CONFIG_HOME:-$HOME/.config}/srp/default"
local SRP_DEFAULT

# ensure config dir exists (will be created on first set-default)
_srp_ensure_dir() {
  mkdir -p "$(dirname "$_srp_default_file")" 2>/dev/null || true
}

# load persisted default
if [ -r "$_srp_default_file" ]; then
  SRP_DEFAULT="$(cat "$_srp_default_file")"
else
  SRP_DEFAULT="a6000"
fi

# main
# If no args -> show default then run start
if [ $# -eq 0 ]; then
  echo "Current default SRP target: $SRP_DEFAULT"
  echo "Starting..."
  set -- start
fi

# support -h/--help right away
case "$1" in
  -h|--help)
    cat <<'EOF'
Usage: srp [start|status|stop|set|current] [alias]
Defaults:
- default alias read from config file "$XDG_CONFIG_HOME/srp/default" or "~/.config/srp/default"
Behavior:
- srp              => show current default and then start it
- srp start [X]    => start ssh-reverse-proxy@X.service (uses default if X omitted)
- srp status [X]   => show status of X, or list ALL running instances if X omitted
- srp stop [X]     => stop ssh-reverse-proxy@X.service (uses default if X omitted)
- srp set X        => persist X as new default for future shells
- srp current      => show current persisted default
EOF
    return 0
    ;;
esac

local action="$1"
local target="${2:-$SRP_DEFAULT}"

case "$action" in
  start)
    sudo systemctl start "ssh-reverse-proxy@${target}.service"
    return $?
    ;;
  status)
    if [ -n "$2" ]; then
      # å¦‚æœç”¨æˆ·æ˜ç¡®æŒ‡å®šäº†æŸä¸ªå®ä¾‹ (ä¾‹å¦‚ srp status B)ï¼Œåˆ™æ‰“å°è¯¦ç»†çš„æ—¥å¿—çŠ¶æ€
      sudo systemctl status "ssh-reverse-proxy@${2}.service"
    else
      # å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šå‚æ•° (åªæ•²äº† srp status)ï¼Œåˆ™åˆ—å‡ºæ‰€æœ‰å®ä¾‹çš„è¿è¡Œæ¦‚å†µ
      echo -e "\nğŸ” [å½“å‰æ‰€æœ‰ SSH åå‘ä»£ç†çŠ¶æ€]:"
      # ä½¿ç”¨ list-units åˆ—å‡ºæ‰€æœ‰çš„ srp æœåŠ¡ï¼Œ--no-pager é˜²æ­¢å®ƒè¿›å…¥ less ç¿»é¡µæ¨¡å¼
      sudo systemctl list-units --type=service "ssh-reverse-proxy@*.service" --no-pager
      
      echo -e "ğŸ“Œ å½“å‰é»˜è®¤ç›®æ ‡: \033[32m$SRP_DEFAULT\033[0m"
      echo "(Tip: è¾“å…¥ 'srp status <alias>' å¯æŸ¥çœ‹æŒ‡å®šå®ä¾‹çš„è¯¦ç»†æ—¥å¿—)"
    fi
    return $?
    ;;
  stop)
    sudo systemctl stop "ssh-reverse-proxy@${target}.service"
    return $?
    ;;
  set)
    if [ -z "$2" ]; then
      echo "Usage: srp set <alias>"
      return 2
    fi
    _srp_ensure_dir
    printf '%s' "$2" > "$_srp_default_file" && SRP_DEFAULT="$2"
    echo "Default SRP target set to: $SRP_DEFAULT"
    return $?
    ;;
  current)
    echo "Current default SRP target: $SRP_DEFAULT"
    return 0
    ;;
  *)
    echo "Unknown action: $action"
    echo "Run: srp -h"
    return 2
    ;;
esac
